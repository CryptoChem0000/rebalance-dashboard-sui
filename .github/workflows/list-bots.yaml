name: List All Bots

on:
  workflow_dispatch:
    inputs:
      show-details:
        description: 'Show detailed information'
        required: false
        type: boolean
        default: true
  push:
    branches:
      - chore/kill-bot

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GKE_CLUSTER: shared-gke-nonprod
  GKE_REGION: us-central1
  NAMESPACE: bolt-prod

jobs:
  list-bots:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup gcloud CLI
      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GKE_PROD_SA_KEY }}"

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GKE_PROJECT }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_REGION }}

      - name: List all CLAMM bots
        run: |
          echo "ü§ñ CLAMM Bots Status Report"
          echo "=========================="
          echo "Date: $(date)"
          echo "Cluster: ${{ env.GKE_CLUSTER }}"
          echo "Namespace: ${{ env.NAMESPACE }}"
          echo ""
          
          # Get all deployments that start with clamm-bot
          echo "üìä Bot Deployments:"
          echo "-------------------"
          
          if [ "${{ github.event.inputs.show-details }}" == "true" ]; then
            # Detailed view
            kubectl get deployments -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=clamm-bot -o custom-columns=NAME:.metadata.name,READY:.status.readyReplicas,DESIRED:.spec.replicas,IMAGE:.spec.template.spec.containers[0].image,AGE:.metadata.creationTimestamp,STOPPED:.metadata.annotations.stopped-at
          else
            # Simple view
            kubectl get deployments -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=clamm-bot
          fi
          
          echo ""
          echo "üì¶ Helm Releases:"
          echo "-----------------"
          helm list -n ${{ env.NAMESPACE }} | grep -E "(NAME|clamm-bot)" || echo "No Helm releases found"
          
          echo ""
          echo "üîç Pod Status:"
          echo "--------------"
          kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=clamm-bot -o wide
          
          # Summary statistics
          echo ""
          echo "üìà Summary:"
          echo "-----------"
          TOTAL=$(kubectl get deployments -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=clamm-bot -o json | jq '.items | length')
          RUNNING=$(kubectl get deployments -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=clamm-bot -o json | jq '[.items[] | select(.spec.replicas > 0)] | length')
          STOPPED=$(kubectl get deployments -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=clamm-bot -o json | jq '[.items[] | select(.spec.replicas == 0)] | length')
          
          echo "Total bots: $TOTAL"
          echo "Running: $RUNNING"
          echo "Stopped: $STOPPED"
          
          # Check for orphaned bots (not in config)
          if [ -f "./.github/configs/clamm-bots.json" ]; then
            echo ""
            echo "‚ö†Ô∏è  Orphaned Bots (not in config):"
            echo "-----------------------------------"
            CONFIGURED=$(jq -r 'keys[]' ./.github/configs/clamm-bots.json)
            DEPLOYED=$(kubectl get deployments -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=clamm-bot -o json | jq -r '.items[].metadata.name')
            
            ORPHANS_FOUND=false
            for bot in $DEPLOYED; do
              if ! echo "$CONFIGURED" | grep -q "^$bot$"; then
                ORPHANS_FOUND=true
                REPLICAS=$(kubectl get deployment $bot -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.replicas}')
                STATUS="Stopped"
                if [ "$REPLICAS" -gt "0" ]; then
                  STATUS="üö® RUNNING ($REPLICAS replicas)"
                fi
                echo "- $bot: $STATUS"
              fi
            done
            
            if [ "$ORPHANS_FOUND" = "false" ]; then
              echo "None found ‚úÖ"
            fi
          fi
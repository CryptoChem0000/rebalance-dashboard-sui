name: Debug Deployment

on:
  workflow_dispatch:
    inputs:
      bot_name:
        description: 'Name of the bot to debug (e.g., clamm-bot-1)'
        required: true
        type: string

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GKE_CLUSTER: shared-gke-nonprod
  GKE_REGION: us-central1
  NAMESPACE: bolt-prod

jobs:
  debug:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GKE_PROD_SA_KEY }}"

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GKE_PROJECT }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_REGION }}

      - name: Debug Deployment Status
        run: |
          BOT_NAME="${{ github.event.inputs.bot_name }}"
          
          echo "# üîç Debugging $BOT_NAME"
          echo ""
          
          # Check for deployment with both possible naming patterns
          DEPLOYMENT_NAME=""
          if kubectl get deployment $BOT_NAME -n $NAMESPACE &> /dev/null; then
            DEPLOYMENT_NAME=$BOT_NAME
          elif kubectl get deployment ${BOT_NAME}-clamm-bot -n $NAMESPACE &> /dev/null; then
            DEPLOYMENT_NAME=${BOT_NAME}-clamm-bot
          fi
          
          if [ -z "$DEPLOYMENT_NAME" ]; then
            echo "‚ùå No deployment found for $BOT_NAME"
            exit 1
          fi
          
          echo "## Deployment Details"
          echo "Found deployment: $DEPLOYMENT_NAME"
          echo ""
          
          # Get deployment details
          echo "### Basic Info"
          kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o wide
          echo ""
          
          # Get the current image
          echo "### Current Image"
          CURRENT_IMAGE=$(kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].image}')
          echo "Image: $CURRENT_IMAGE"
          echo ""
          
          # Parse image details
          if [[ $CURRENT_IMAGE =~ ^(.+):([^:]+)$ ]]; then
            IMAGE_REPO="${BASH_REMATCH[1]}"
            IMAGE_TAG="${BASH_REMATCH[2]}"
            echo "Repository: $IMAGE_REPO"
            echo "Tag: $IMAGE_TAG"
          fi
          echo ""
          
          # Get deployment timestamps
          echo "### Deployment Timeline"
          CREATED=$(kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.metadata.creationTimestamp}')
          echo "Created: $CREATED"
          
          # Get last update time from deployment
          LAST_UPDATE=$(kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.metadata.annotations.kubectl\.kubernetes\.io/last-applied-configuration}' | jq -r '.metadata.annotations."deployment.kubernetes.io/revision"' 2>/dev/null || echo "N/A")
          
          # Get more deployment info
          echo ""
          echo "### Deployment Conditions"
          kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o json | jq '.status.conditions[] | {type: .type, status: .status, reason: .reason, message: .message, lastUpdateTime: .lastUpdateTime}'
          echo ""
          
          # Check pods
          echo "### Pod Status"
          kubectl get pods -l app.kubernetes.io/instance=$BOT_NAME -n $NAMESPACE -o wide
          echo ""
          
          # Get pod details
          echo "### Pod Images (Running)"
          kubectl get pods -l app.kubernetes.io/instance=$BOT_NAME -n $NAMESPACE -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].image}{"\n"}{end}'
          echo ""
          
          # Get recent events
          echo "### Recent Events"
          kubectl get events --field-selector involvedObject.name=$DEPLOYMENT_NAME -n $NAMESPACE --sort-by='.lastTimestamp' | tail -10
          echo ""
          
          # Check if the image actually exists in the registry
          echo "### Checking Image in Registry"
          
          # Get the current pod to see what image it's actually running
          RUNNING_POD=$(kubectl get pods -l app.kubernetes.io/instance=$BOT_NAME -n $NAMESPACE -o jsonpath='{.items[0].metadata.name}')
          if [ -n "$RUNNING_POD" ]; then
            echo "#### Running Pod: $RUNNING_POD"
            echo "Pod Creation Time:"
            kubectl get pod $RUNNING_POD -n $NAMESPACE -o jsonpath='{.metadata.creationTimestamp}'
            echo ""
            echo "Pod Image (actual):"
            kubectl get pod $RUNNING_POD -n $NAMESPACE -o jsonpath='{.spec.containers[0].image}'
            echo ""
            echo "Image ID (what's actually running):"
            kubectl get pod $RUNNING_POD -n $NAMESPACE -o jsonpath='{.status.containerStatuses[0].imageID}'
            echo ""
          fi
          
          # Get deployment history
          echo "### Deployment History (Recent)"
          kubectl rollout history deployment/$DEPLOYMENT_NAME -n $NAMESPACE | tail -10
          echo ""
          
          # Check for any annotations about withdrawals or disabling
          echo "### Deployment Annotations"
          kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.metadata.annotations}' | jq .
          echo ""
          
          # Summary
          echo "## Summary"
          echo "- Current Image Tag: $IMAGE_TAG"
          if [[ "$IMAGE_TAG" == "latest" ]]; then
            echo "‚ö†Ô∏è  **WARNING**: Deployment is using 'latest' tag which can cause caching issues"
            echo "  Recommendation: Deploy with a specific version tag instead"
          fi
          
          # Check imagePullPolicy
          PULL_POLICY=$(kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].imagePullPolicy}')
          echo "- Image Pull Policy: $PULL_POLICY"
          if [[ "$PULL_POLICY" == "IfNotPresent" && "$IMAGE_TAG" == "latest" ]]; then
            echo "‚ö†Ô∏è  **WARNING**: Using 'IfNotPresent' with 'latest' tag can cause old images to be used"
          fi

      - name: Check Recent Builds
        run: |
          echo ""
          echo "## Recent Image Builds"
          echo "To see what images are available, check:"
          echo "https://github.com/${{ github.repository }}/packages"

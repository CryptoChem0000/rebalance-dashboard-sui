name: Deploy CLAMM Bots

on:
  push:
    tags:
      - "v*"

  workflow_dispatch:
    inputs:
      environments:
        description: "Comma-separated list of environments to deploy (e.g., clamm-bot-1,clamm-bot-2)"
        required: false
        default: ""
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GKE_CLUSTER: shared-gke-nonprod
  GKE_REGION: us-central1
  HELM_CHART_PATH: ./charts
  CONFIG_FILE: ./.github/configs/clamm-bots.json

defaults:
  run:
    shell: bash

jobs:
  # First job to determine which environments to deploy and validate them
  setup:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.output-matrix.outputs.environments }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get available environments from GitHub
        id: get-github-envs
        uses: actions/github-script@v6
        with:
          script: |
            try {
              const { data: environments } = await github.rest.repos.getAllEnvironments({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const envNames = environments.environments.map(env => env.name);
              console.log('Available GitHub environments:', envNames);
              core.setOutput('github_environments', JSON.stringify(envNames));
            } catch (error) {
              console.error('Error fetching environments:', error);
              core.setOutput('github_environments', '[]');
            }

      - name: Determine and validate environments
        id: validate-envs
        run: |
          # Get GitHub environments
          GITHUB_ENVS='${{ steps.get-github-envs.outputs.github_environments }}'
          echo "GitHub environments: $GITHUB_ENVS"

          # Read bot configurations from JSON
          BOT_CONFIGS=$(jq -r 'keys[]' $CONFIG_FILE)
          echo "Configured bots in JSON: $BOT_CONFIGS"

          # Determine which environments to deploy
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.environments }}" ]; then
            # Use manual input if provided
            REQUESTED_ENVS="${{ github.event.inputs.environments }}"
            IFS=',' read -ra ENVS_ARRAY <<< "$REQUESTED_ENVS"
          else
            # Use all bots from config file
            ENVS_ARRAY=($BOT_CONFIGS)
          fi

          # Validate each environment
          VALID_ENVS=()
          INVALID_ENVS=()

          for env in "${ENVS_ARRAY[@]}"; do
            env=$(echo "$env" | xargs) # Trim whitespace
            
            # Check if bot exists in config file
            if ! jq -e ".\"$env\"" $CONFIG_FILE > /dev/null 2>&1; then
              echo "âŒ $env: Not found in $CONFIG_FILE"
              INVALID_ENVS+=("$env (not in config)")
              continue
            fi
            
            # Check if GitHub environment exists
            if ! echo "$GITHUB_ENVS" | jq -e ".[] | select(. == \"$env\")" > /dev/null 2>&1; then
              echo "âŒ $env: GitHub environment not found"
              INVALID_ENVS+=("$env (no GitHub env)")
              continue
            fi
            
            echo "âœ… $env: Valid (found in both config and GitHub environments)"
            VALID_ENVS+=("$env")
          done

          # Output results
          if [ ${#VALID_ENVS[@]} -eq 0 ]; then
            echo "::error::No valid environments found to deploy"
            exit 1
          fi

          if [ ${#INVALID_ENVS[@]} -gt 0 ]; then
            echo "::warning::Skipping invalid environments: ${INVALID_ENVS[*]}"
          fi

          # Save to file for next step
          printf '%s\n' "${VALID_ENVS[@]}" > valid-envs.txt
          
          # Also output count for verification
          echo "Total valid environments: ${#VALID_ENVS[@]}"

      - name: Validate DATABASE_URL repository secret exists
        run: |
          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "::error::DATABASE_URL repository secret not found"
            echo "Please add the DATABASE_URL secret to the repository secrets"
            exit 1
          fi
          echo "âœ… DATABASE_URL repository secret found"

      - name: Create matrix output
        id: output-matrix
        run: |
          # Read valid environments from file
          VALID_ENVS=()
          while IFS= read -r line; do
            VALID_ENVS+=("$line")
          done < valid-envs.txt
          
          # Create JSON array manually to ensure correct format
          JSON="["
          for i in "${!VALID_ENVS[@]}"; do
            if [ $i -ne 0 ]; then
              JSON="${JSON},"
            fi
            # Ensure proper escaping
            ESCAPED=$(echo "${VALID_ENVS[$i]}" | sed 's/"/\\"/g')
            JSON="${JSON}\"${ESCAPED}\""
          done
          JSON="${JSON}]"
          
          echo "Matrix JSON: $JSON"
          
          # Verify it's valid JSON
          echo "$JSON" | jq . > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "::error::Invalid JSON generated"
            exit 1
          fi
          
          # Output to GitHub
          echo "environments=$JSON" >> $GITHUB_OUTPUT

  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,format=short
            type=ref,event=tag

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    needs: [build-and-push, setup]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ fromJson(needs.setup.outputs.environments) }}
      fail-fast: false
    environment: ${{ matrix.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate MNEMONIC secret exists
        run: |
          if [ -z "${{ secrets.MNEMONIC }}" ]; then
            echo "::error::MNEMONIC secret not found in environment ${{ matrix.environment }}"
            echo "Please add the MNEMONIC secret to the GitHub environment: ${{ matrix.environment }}"
            exit 1
          fi
          echo "âœ… MNEMONIC secret found for ${{ matrix.environment }}"

      # Setup gcloud CLI
      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GKE_PROD_SA_KEY }}"

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GKE_PROJECT }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_REGION }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.19.0"

      - name: Read bot configuration from JSON
        id: bot-config
        run: |
          # Read the specific bot configuration
          BOT_CONFIG=$(jq -r '."${{ matrix.environment }}"' $CONFIG_FILE)

          if [ "$BOT_CONFIG" == "null" ]; then
            echo "::error::Configuration for ${{ matrix.environment }} not found in $CONFIG_FILE"
            exit 1
          fi

          # Export each configuration value
          echo "OSMOSIS_POOL_ID=$(echo "$BOT_CONFIG" | jq -r '.OSMOSIS_POOL_ID')" >> $GITHUB_OUTPUT
          echo "REBALANCE_THRESHOLD_PERCENT=$(echo "$BOT_CONFIG" | jq -r '.REBALANCE_THRESHOLD_PERCENT')" >> $GITHUB_OUTPUT
          echo "OSMOSIS_POSITION_BAND_PERCENTAGE=$(echo "$BOT_CONFIG" | jq -r '.OSMOSIS_POSITION_BAND_PERCENTAGE')" >> $GITHUB_OUTPUT
          echo "WATCH_FREQUENCY=$(echo "$BOT_CONFIG" | jq -r '.WATCH_FREQUENCY')" >> $GITHUB_OUTPUT

          # Display configuration
          echo "Configuration for ${{ matrix.environment }}:"
          echo "$BOT_CONFIG" | jq .

      - name: Deploy to GKE using Helm
        env:
          TAG: ${{ github.sha }}
          COMMIT_HASH: ${{ github.sha }}
          DEPLOYMENT_NAME: ${{ matrix.environment }}
          NAMESPACE: bolt-prod
          # Repository secrets
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          # Secrets from GitHub environment
          MNEMONIC: ${{ secrets.MNEMONIC }}
          # Values from JSON config
          OSMOSIS_POOL_ID: ${{ steps.bot-config.outputs.OSMOSIS_POOL_ID }}
          REBALANCE_THRESHOLD_PERCENT: ${{ steps.bot-config.outputs.REBALANCE_THRESHOLD_PERCENT }}
          OSMOSIS_POSITION_BAND_PERCENTAGE: ${{ steps.bot-config.outputs.OSMOSIS_POSITION_BAND_PERCENTAGE }}
          WATCH_FREQUENCY: ${{ steps.bot-config.outputs.WATCH_FREQUENCY }}
        run: |
          echo "Deploying $DEPLOYMENT_NAME..."
          echo "Pool ID: $OSMOSIS_POOL_ID"
          echo "Rebalance Threshold: $REBALANCE_THRESHOLD_PERCENT%"
          echo "Position Band: $OSMOSIS_POSITION_BAND_PERCENTAGE%"
          echo "Watch Frequency: $WATCH_FREQUENCY seconds"

          # Base64 encode the values
          export DATABASE_URL_B64=$(echo -n "$DATABASE_URL" | base64)
          export MNEMONIC_B64=$(echo -n "$MNEMONIC" | base64)
          export OSMOSIS_POOL_ID_B64=$(echo -n "$OSMOSIS_POOL_ID" | base64)
          export REBALANCE_THRESHOLD_PERCENT_B64=$(echo -n "$REBALANCE_THRESHOLD_PERCENT" | base64)
          export OSMOSIS_POSITION_BAND_PERCENTAGE_B64=$(echo -n "$OSMOSIS_POSITION_BAND_PERCENTAGE" | base64)
          export WATCH_FREQUENCY_B64=$(echo -n "$WATCH_FREQUENCY" | base64)

          # Deploy using Helm
          helm upgrade --install $DEPLOYMENT_NAME $HELM_CHART_PATH \
            --namespace $NAMESPACE \
            --create-namespace \
            --set image.repository=${REGISTRY}/${IMAGE_NAME} \
            --set image.tag=sha-${COMMIT_HASH:0:7} \
            --set secrets.app-secrets.data.DATABASE_URL="$DATABASE_URL_B64" \
            --set secrets.app-secrets.data.MNEMONIC="$MNEMONIC_B64" \
            --set secrets.app-secrets.data.OSMOSIS_POOL_ID="$OSMOSIS_POOL_ID_B64" \
            --set secrets.app-secrets.data.REBALANCE_THRESHOLD_PERCENT="$REBALANCE_THRESHOLD_PERCENT_B64" \
            --set secrets.app-secrets.data.OSMOSIS_POSITION_BAND_PERCENTAGE="$OSMOSIS_POSITION_BAND_PERCENTAGE_B64" \
            --set secrets.app-secrets.data.WATCH_FREQUENCY="$WATCH_FREQUENCY_B64" \
            --values ./charts/values.yaml \
            --wait --timeout 2m

          echo "âœ… Successfully deployed $DEPLOYMENT_NAME"

      - name: Verify deployment
        env:
          NAMESPACE: bolt-prod
        run: |
          echo "Checking deployment status..."
          kubectl -n $NAMESPACE get deployment ${{ matrix.environment }}
          kubectl -n $NAMESPACE get pods -l app.kubernetes.io/instance=${{ matrix.environment }}

  # Cleanup job runs AFTER deploy to stop removed bots
  cleanup:
    needs: [deploy]
    runs-on: ubuntu-latest
    # Only run on non-manual triggers or when no specific environments were selected
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.environments == ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GKE_PROD_SA_KEY }}"

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GKE_PROJECT }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_REGION }}
        
      - name: Stop removed bots (preserve data)
        env:
          NAMESPACE: bolt-prod
        run: |
          echo "ðŸ” Checking for bots to stop..."
          
          # Get all deployed clamm-bot deployments
          DEPLOYED=$(kubectl get deployments -n $NAMESPACE -o json | jq -r '.items[] | select(.metadata.name | startswith("clamm-bot-")) | .metadata.name')
          
          if [ -z "$DEPLOYED" ]; then
            echo "No clamm-bot deployments found"
            exit 0
          fi
          
          # Get configured bots
          CONFIGURED=$(jq -r 'keys[]' $CONFIG_FILE)
          
          echo "Deployed bots: $DEPLOYED"
          echo "Configured bots: $CONFIGURED"
          
          # Find bots to stop
          STOPPED_COUNT=0
          for bot in $DEPLOYED; do
            if ! echo "$CONFIGURED" | grep -q "^$bot$"; then
              # Check current replica count
              CURRENT_REPLICAS=$(kubectl get deployment $bot -n $NAMESPACE -o jsonpath='{.spec.replicas}')
              
              if [ "$CURRENT_REPLICAS" -gt "0" ]; then
                echo "â¸ï¸  Stopping $bot (not in config anymore)..."
                kubectl scale deployment $bot --replicas=0 -n $NAMESPACE
                echo "âœ… $bot stopped but preserved (PVC and configs intact)"
                
                # Add a label to indicate it's stopped by automation
                kubectl label deployment $bot -n $NAMESPACE stopped-by-automation=true --overwrite
                kubectl annotate deployment $bot -n $NAMESPACE stopped-at="$(date -u +%Y-%m-%dT%H:%M:%SZ)" --overwrite
                
                STOPPED_COUNT=$((STOPPED_COUNT + 1))
              else
                echo "â„¹ï¸  $bot is already stopped"
              fi
            else
              echo "âœ… $bot is configured and should be running"
            fi
          done
          
          if [ $STOPPED_COUNT -eq 0 ]; then
            echo "No bots needed to be stopped"
          fi
          
          echo ""
          echo "ðŸ“‹ Summary of all stopped bots:"
          kubectl get deployments -n $NAMESPACE -l stopped-by-automation=true -o custom-columns="NAME:.metadata.name,STOPPED_AT:.metadata.annotations.stopped-at,REPLICAS:.spec.replicas" 2>/dev/null || echo "No stopped bots found"

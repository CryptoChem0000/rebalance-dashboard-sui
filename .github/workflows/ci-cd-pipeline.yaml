name: Deploy CLAMM Bots

on:
  push:
    tags:
      - "v*"
    branches:
      - "feat/bolt-1176-update-cicd-to-dynamically-deploy-bots"

  workflow_dispatch:
    inputs:
      environments:
        description: "Comma-separated list of environments to deploy (e.g., clamm-bot-1,clamm-bot-2)"
        required: false
        default: ""
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GKE_CLUSTER: shared-gke-nonprod
  GKE_REGION: us-central1
  HELM_CHART_PATH: ./charts
  CONFIG_FILE: ./.github/configs/clamm-bots.json

defaults:
  run:
    shell: bash

jobs:
  # First job to determine which environments to deploy and validate them
  setup:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.set-matrix.outputs.environments }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get available environments from GitHub
        id: get-github-envs
        uses: actions/github-script@v6
        with:
          script: |
            try {
              const { data: environments } = await github.rest.repos.getAllEnvironments({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const envNames = environments.environments.map(env => env.name);
              console.log('Available GitHub environments:', envNames);
              core.setOutput('github_environments', JSON.stringify(envNames));
            } catch (error) {
              console.error('Error fetching environments:', error);
              core.setOutput('github_environments', '[]');
            }

      - name: Determine and validate environments
        id: validate-envs
        run: |
          # Get GitHub environments
          GITHUB_ENVS='${{ steps.get-github-envs.outputs.github_environments }}'
          echo "GitHub environments: $GITHUB_ENVS"

          # Read bot configurations from JSON
          BOT_CONFIGS=$(jq -r 'keys[]' $CONFIG_FILE)
          echo "Configured bots in JSON: $BOT_CONFIGS"

          # Determine which environments to deploy
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.environments }}" ]; then
            # Use manual input if provided
            REQUESTED_ENVS="${{ github.event.inputs.environments }}"
            IFS=',' read -ra ENVS_ARRAY <<< "$REQUESTED_ENVS"
          else
            # Use all bots from config file
            ENVS_ARRAY=($BOT_CONFIGS)
          fi

          # Validate each environment
          VALID_ENVS=()
          INVALID_ENVS=()

          for env in "${ENVS_ARRAY[@]}"; do
            env=$(echo "$env" | xargs) # Trim whitespace
            
            # Check if bot exists in config file
            if ! jq -e ".\"$env\"" $CONFIG_FILE > /dev/null 2>&1; then
              echo "❌ $env: Not found in $CONFIG_FILE"
              INVALID_ENVS+=("$env (not in config)")
              continue
            fi
            
            # Check if GitHub environment exists
            if ! echo "$GITHUB_ENVS" | jq -e ".[] | select(. == \"$env\")" > /dev/null 2>&1; then
              echo "❌ $env: GitHub environment not found"
              INVALID_ENVS+=("$env (no GitHub env)")
              continue
            fi
            
            echo "✅ $env: Valid (found in both config and GitHub environments)"
            VALID_ENVS+=("$env")
          done

          # Output results
          if [ ${#VALID_ENVS[@]} -eq 0 ]; then
            echo "::error::No valid environments found to deploy"
            exit 1
          fi

          if [ ${#INVALID_ENVS[@]} -gt 0 ]; then
            echo "::warning::Skipping invalid environments: ${INVALID_ENVS[*]}"
          fi

          # Alternative approach - write to file and use artifact
          printf '%s\n' "${VALID_ENVS[@]}" | jq -R . | jq -s -c . > valid-environments.json
          cat valid-environments.json
          
          # Also try direct array format
          VALID_JSON='['
          for i in "${!VALID_ENVS[@]}"; do
            if [ $i -ne 0 ]; then
              VALID_JSON="${VALID_JSON},"
            fi
            VALID_JSON="${VALID_JSON}\"${VALID_ENVS[$i]}\""
          done
          VALID_JSON="${VALID_JSON}]"
          
          echo "Valid environments to deploy: $VALID_JSON"
          echo "valid_environments=$VALID_JSON" >> $GITHUB_OUTPUT

      - name: Set deployment matrix
        id: set-matrix
        run: |
          echo "environments=${{ steps.validate-envs.outputs.valid_environments }}" >> $GITHUB_OUTPUT

  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,format=short
            type=ref,event=tag

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    needs: [build-and-push, setup]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ fromJson(needs.setup.outputs.environments) }}
      fail-fast: false
    environment: ${{ matrix.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate MNEMONIC secret exists
        run: |
          if [ -z "${{ secrets.MNEMONIC }}" ]; then
            echo "::error::MNEMONIC secret not found in environment ${{ matrix.environment }}"
            echo "Please add the MNEMONIC secret to the GitHub environment: ${{ matrix.environment }}"
            exit 1
          fi
          echo "✅ MNEMONIC secret found for ${{ matrix.environment }}"

      # Setup gcloud CLI
      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GKE_PROD_SA_KEY }}"

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GKE_PROJECT }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_REGION }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: "latest"

      - name: Read bot configuration from JSON
        id: bot-config
        run: |
          # Read the specific bot configuration
          BOT_CONFIG=$(jq -r '."${{ matrix.environment }}"' $CONFIG_FILE)

          if [ "$BOT_CONFIG" == "null" ]; then
            echo "::error::Configuration for ${{ matrix.environment }} not found in $CONFIG_FILE"
            exit 1
          fi

          # Export each configuration value
          echo "OSMOSIS_POOL_ID=$(echo "$BOT_CONFIG" | jq -r '.OSMOSIS_POOL_ID')" >> $GITHUB_OUTPUT
          echo "REBALANCE_THRESHOLD_PERCENT=$(echo "$BOT_CONFIG" | jq -r '.REBALANCE_THRESHOLD_PERCENT')" >> $GITHUB_OUTPUT
          echo "OSMOSIS_POSITION_BAND_PERCENTAGE=$(echo "$BOT_CONFIG" | jq -r '.OSMOSIS_POSITION_BAND_PERCENTAGE')" >> $GITHUB_OUTPUT
          echo "WATCH_FREQUENCY=$(echo "$BOT_CONFIG" | jq -r '.WATCH_FREQUENCY')" >> $GITHUB_OUTPUT

          # Display configuration
          echo "Configuration for ${{ matrix.environment }}:"
          echo "$BOT_CONFIG" | jq .

      - name: Deploy to GKE using Helm
        env:
          TAG: ${{ github.sha }}
          COMMIT_HASH: ${{ github.sha }}
          DEPLOYMENT_NAME: ${{ matrix.environment }}
          NAMESPACE: bolt-prod
          # Secret from GitHub environment
          MNEMONIC: ${{ secrets.MNEMONIC }}
          # Values from JSON config
          OSMOSIS_POOL_ID: ${{ steps.bot-config.outputs.OSMOSIS_POOL_ID }}
          REBALANCE_THRESHOLD_PERCENT: ${{ steps.bot-config.outputs.REBALANCE_THRESHOLD_PERCENT }}
          OSMOSIS_POSITION_BAND_PERCENTAGE: ${{ steps.bot-config.outputs.OSMOSIS_POSITION_BAND_PERCENTAGE }}
          WATCH_FREQUENCY: ${{ steps.bot-config.outputs.WATCH_FREQUENCY }}
        run: |
          echo "Deploying $DEPLOYMENT_NAME..."
          echo "Pool ID: $OSMOSIS_POOL_ID"
          echo "Rebalance Threshold: $REBALANCE_THRESHOLD_PERCENT%"
          echo "Position Band: $OSMOSIS_POSITION_BAND_PERCENTAGE%"
          echo "Watch Frequency: $WATCH_FREQUENCY seconds"

          # Base64 encode the values
          export MNEMONIC_B64=$(echo -n "$MNEMONIC" | base64)
          export OSMOSIS_POOL_ID_B64=$(echo -n "$OSMOSIS_POOL_ID" | base64)
          export REBALANCE_THRESHOLD_PERCENT_B64=$(echo -n "$REBALANCE_THRESHOLD_PERCENT" | base64)
          export OSMOSIS_POSITION_BAND_PERCENTAGE_B64=$(echo -n "$OSMOSIS_POSITION_BAND_PERCENTAGE" | base64)
          export WATCH_FREQUENCY_B64=$(echo -n "$WATCH_FREQUENCY" | base64)

          # Deploy using Helm
          helm upgrade --install $DEPLOYMENT_NAME $HELM_CHART_PATH \
            --namespace $NAMESPACE \
            --create-namespace \
            --set image.repository=${REGISTRY}/${IMAGE_NAME} \
            --set image.tag=sha-${COMMIT_HASH:0:7} \
            --set secrets.app-secrets.data.MNEMONIC="$MNEMONIC_B64" \
            --set secrets.app-secrets.data.OSMOSIS_POOL_ID="$OSMOSIS_POOL_ID_B64" \
            --set secrets.app-secrets.data.REBALANCE_THRESHOLD_PERCENT="$REBALANCE_THRESHOLD_PERCENT_B64" \
            --set secrets.app-secrets.data.OSMOSIS_POSITION_BAND_PERCENTAGE="$OSMOSIS_POSITION_BAND_PERCENTAGE_B64" \
            --set secrets.app-secrets.data.WATCH_FREQUENCY="$WATCH_FREQUENCY_B64" \
            --values ./charts/values.yaml \
            --wait --timeout 2m

          echo "✅ Successfully deployed $DEPLOYMENT_NAME"

      - name: Verify deployment
        run: |
          echo "Checking deployment status..."
          kubectl -n ${{ env.NAMESPACE }} get deployment ${{ matrix.environment }}
          kubectl -n ${{ env.NAMESPACE }} get pods -l app.kubernetes.io/instance=${{ matrix.environment }}
